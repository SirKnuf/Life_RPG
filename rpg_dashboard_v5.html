<!DOCTYPE html>
<html lang="de">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life-RPG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { --rpg-bg: #1f2937; --rpg-primary: #10b981; --rpg-secondary: #fcd34d; }
        body { font-family: 'Inter', sans-serif; background-color: var(--rpg-bg); color: #f3f4f6; padding: 20px; margin: 0; }
        .stat-card { background-color: #374151; border: 2px solid var(--rpg-primary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        .progress-bar-container { height: 12px; background-color: #4b5563; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; transition: width 0.5s ease-in-out; }
        .scroll-area { height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--rpg-primary) transparent; }
        summary { cursor: pointer; }
        summary::-webkit-details-marker { color: var(--rpg-secondary); }
    </style>
</head>
<body>

<div class="max-w-7xl mx-auto space-y-8">
    
    <header class="text-center pb-4 border-b border-gray-600">
        <h1 class="text-4xl font-extrabold text-rpg-primary">LIFE-RPG DASHBOARD V5</h1>
        <p class="text-lg text-gray-300 mt-1" id="latest-sync-date">Lade...</p>
    </header>

    <section>
        <div id="player-status-card" class="stat-card p-6 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <p class="text-sm font-semibold text-gray-400">Level</p>
                <p id="current-level" class="text-5xl font-extrabold text-white">?</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-gray-400">Gesamt-XP</p>
                <p id="total-xp" class="text-3xl font-bold text-white">0.0</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-gray-400">Fortschritt</p>
                <div class="progress-bar-container">
                    <div id="xp-progress-bar" class="progress-bar" style="width: 0%; background-color: var(--rpg-secondary);"></div>
                </div>
                <p class="text-sm text-gray-300 mt-1"><span id="xp-since-level">0</span> / 100 XP</p>
            </div>
        </div>
    </section>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">XP Heute</p>
            <p id="xp-gained-today" class="text-3xl font-bold text-rpg-primary">0.0</p>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">Aufgaben erledigt</p>
            <p id="tasks-completed-total" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <h3 class="text-xs font-semibold text-rpg-secondary uppercase">Highlights</h3>
            <div class="text-sm mt-1">
                <p class="flex justify-between"><span>KM:</span> <span id="total-run-km-display" class="text-rpg-primary font-mono">0.0</span></p>
                <p class="flex justify-between"><span>Zeit:</span> <span id="total-run-minutes-display" class="text-rpg-primary font-mono">0h</span></p>
                <p class="flex justify-between"><span>Sally (Best):</span> <span id="latest-sallyup-display" class="text-rpg-primary font-mono">N/A</span></p>
            </div>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">Aktivzeit Heute</p>
            <p id="minutes-spent-total" class="text-3xl font-bold text-white">0 min</p>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-8 space-y-8">
        <details class="stat-card p-5 rounded-lg" open>
            <summary class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Skill-Fortschritt (Gesamt)</summary>
            <div id="skill-progress-list" class="space-y-4 scroll-area pr-2"></div>
        </details>

        <details class="stat-card p-5 rounded-lg">
            <summary class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Individuelle Ziel-Fortschritte</summary>
            <div id="goal-progress-list" class="space-y-4"></div>
        </details>

        <details class="stat-card p-5 rounded-lg border-emerald-500">
            <summary class="text-xl font-bold text-rpg-primary mb-4 border-b border-gray-600 pb-2">Aktiver Tag</summary>
            <div id="daily-breakdown-list" class="space-y-4"></div>
        </details>
    </div>

    <div class="lg:col-span-4 space-y-8">
        <details class="stat-card p-5 rounded-lg">
            <summary class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Offene Quests</summary>
            <div id="open-tasks-list" class="space-y-2 scroll-area pr-2"></div>
        </details>

        <details class="stat-card p-5 rounded-lg border-emerald-500">
            <summary class="text-xl font-bold text-rpg-primary mb-4 border-b border-gray-600 pb-2">Heute abgeschlossen</summary>
            <div id="completed-today-list" class="space-y-2 scroll-area pr-2"></div>
        </details>
    </div>
</div>
</div>

<script>
// <START_JSON_INJECTION>
    const MOCK_DATA = {
    "total_xp": 1155.15,
    "skill_xp_gained": {
        "Allgemein": 147.0,
        "Finanziell": 176.0,
        "Sozial": 234.67,
        "Sprachlich": 7.5,
        "Spirituell": 73.5,
        "Physisch": 86.42,
        "Intellektuell": 430.07
    },
    "run_metrics": {
        "total_km": 30.26,
        "total_minutes": 150.6
    },
    "sallyup_best_time": 2.5,
    "last_processed_date": "2026-02-05",
    "open_tasks": {
        "Allgemein": [
            "Bürgerbüro (führungszeugnis und einwohnermeldeamt)",
            "Astrophysik Vorlesungen (nach 29.01)"
        ],
        "Finanziell": [],
        "Sozial": [],
        "Sprachlich": [],
        "Spirituell": [],
        "Physisch": [],
        "Intellektuell": []
    },
    "latest_daily_stats": {
        "total_xp_today": 6.0,
        "tasks_today": 2,
        "minutes_today": 180.0,
        "daily_breakdown": {
            "Allgemein": 0.0,
            "Finanziell": 0.0,
            "Sozial": 0.0,
            "Sprachlich": 0.0,
            "Spirituell": 0.0,
            "Physisch": 0.0,
            "Intellektuell": 6.0
        },
        "completed_today": [
            "PKM Vorlesung (90m) #study ",
            "Quanten Vorlesung (90m) #study"
        ]
    },
    "goal_progress": [
        {
            "title": "PKM",
            "current": 13.0,
            "target": 30.0,
            "unit": "Lektionen",
            "end_date": "2026-12-31",
            "remaining": 17.0,
            "days_remaining": 330,
            "daily_workload": 0.05
        },
        {
            "title": "QuantenAufgaben",
            "current": 4.0,
            "target": 33.0,
            "unit": "Lektionen",
            "end_date": "2026-12-31",
            "remaining": 29.0,
            "days_remaining": 330,
            "daily_workload": 0.09
        },
        {
            "title": "Quanten",
            "current": 10.0,
            "target": 77.0,
            "unit": "Lektionen",
            "end_date": "2026-12-31",
            "remaining": 67.0,
            "days_remaining": 330,
            "daily_workload": 0.2
        },
        {
            "title": "PKMAufgaben",
            "current": 13.0,
            "target": 23.0,
            "unit": "Lektionen",
            "end_date": "2026-12-31",
            "remaining": 10.0,
            "days_remaining": 330,
            "daily_workload": 0.03
        }
    ]
};
// <END_JSON_INJECTION>

    function createBar(name, xp, percent, color) {
        return `<div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-bold text-gray-300 uppercase">${name}</span>
                <span class="text-rpg-secondary font-mono">${xp.toFixed(1)} XP</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percent}%; background-color: ${color};"></div>
            </div>
        </div>`;
    }

    function createGoalBar(title, current, target, unit, endDate, dailyWorkload, daysRemaining) {
        const safeTarget = target > 0 ? target : 1;
        const percent = Math.min((current / safeTarget) * 100, 100);
        const unitLabel = unit ? ` ${unit}` : '';
        let deadlineInfo = '';
        if (endDate) {
            const workloadText = Number.isFinite(dailyWorkload)
                ? `${dailyWorkload.toFixed(2)}${unitLabel}/Tag`
                : 'N/A';
            const daysText = Number.isFinite(daysRemaining) ? ` · ${daysRemaining} Tage` : '';
            deadlineInfo = `<p class="text-xs text-gray-400 mt-1">Tagesziel: ${workloadText} · bis ${endDate}${daysText}</p>`;
        }
        return `<div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-bold text-gray-300 uppercase">${title}</span>
                <span class="text-rpg-secondary font-mono">${current}${unitLabel} / ${target}${unitLabel}</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percent}%; background-color: var(--rpg-secondary);"></div>
            </div>
            ${deadlineInfo}
        </div>`;
    }

    async function loadDashboardData() {
        try {
            const response = await fetch('08_System/life_rpg_data_v5.json', { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.warn('Dashboard nutzt eingebettete Daten (Fallback).', error);
            return MOCK_DATA;
        }
    }

    async function renderDashboard() {
        const stats = await loadDashboardData();
        
        // Header & Status
        document.getElementById('latest-sync-date').textContent = `Synchro: ${stats.last_processed_date || 'N/A'}`;
        const txp = stats.total_xp || 0;
        document.getElementById('total-xp').textContent = txp.toFixed(2);
        document.getElementById('current-level').textContent = Math.floor(txp / 100) + 1;
        document.getElementById('xp-since-level').textContent = (txp % 100).toFixed(1);
        document.getElementById('xp-progress-bar').style.width = `${txp % 100}%`;

        // Metriken
        const daily = stats.latest_daily_stats || {};
        document.getElementById('xp-gained-today').textContent = (daily.total_xp_today || 0).toFixed(2);
        document.getElementById('tasks-completed-total').textContent = daily.tasks_today || 0;
        document.getElementById('minutes-spent-total').textContent = `${Math.round(daily.minutes_today || 0)} min`;
        
        const rkm = stats.run_metrics?.total_km || 0;
        const rmin = stats.run_metrics?.total_minutes || 0;
        document.getElementById('total-run-km-display').textContent = rkm.toFixed(1) + " km";
        document.getElementById('total-run-minutes-display').textContent = Math.floor(rmin/60) + "h " + Math.round(rmin%60) + "m";
        // --- Sally Up Bestzeit Anzeige ---
        const sallyMinRaw = stats.sallyup_best_time || 0;
        const sallyDisplay = document.getElementById('latest-sallyup-display');
        if (sallyDisplay) {
            if (sallyMinRaw > 0) {
                const sMin = Math.floor(sallyMinRaw);
                const sSec = Math.round((sallyMinRaw - sMin) * 60);
                sallyDisplay.textContent = `${sMin}:${sSec.toString().padStart(2, '0')} min`;
            } else {
                sallyDisplay.textContent = "0:00 min";
            }
        }

        // 1. Spalte: Gesamt Skills
        const sList = document.getElementById('skill-progress-list');
        const sData = stats.skill_xp_gained || {};
        const maxS = Math.max(...Object.values(sData), 1);
        sList.innerHTML = '';
        Object.entries(sData).sort(([,a],[,b]) => b-a).forEach(([n, x]) => {
            if(x > 0) sList.innerHTML += createBar(n, x, (x/maxS)*100, 'var(--rpg-primary)');
        });

        // Individuelle Ziele
        const goalList = document.getElementById('goal-progress-list');
        goalList.innerHTML = '';
        const goalsRaw = stats.goal_progress || stats.individual_goals || [];
        const goals = Array.isArray(goalsRaw)
            ? goalsRaw
            : Object.entries(goalsRaw).map(([title, goal]) => ({ title, ...goal }));
        if (goals.length === 0) {
            goalList.innerHTML = "<p class='text-gray-500'>Keine individuellen Ziele hinterlegt.</p>";
        } else {
            goals.forEach(goal => {
                const title = goal.title || goal.name || "Ziel";
                const current = Number(goal.current ?? goal.progress ?? 0);
                const target = Number(goal.target ?? goal.goal ?? 0);
                const unit = goal.unit || "";
                const endDate = goal.end_date || goal.endDate || "";
                const dailyWorkload = Number(goal.daily_workload ?? goal.dailyWorkload);
                const daysRemaining = Number(goal.days_remaining ?? goal.daysRemaining);
                goalList.innerHTML += createGoalBar(title, current, target, unit, endDate, dailyWorkload, daysRemaining);
            });
        }

        // 2. Spalte: Offene Quests
        const oList = document.getElementById('open-tasks-list');
        oList.innerHTML = '';
        Object.entries(stats.open_tasks || {}).forEach(([cat, tasks]) => {
            tasks.forEach(t => {
                oList.innerHTML += `<div class="text-sm p-2 bg-gray-800/50 rounded border-l-4 border-yellow-500 mb-1">${t}</div>`;
            });
        });

        // 3. Spalte: Heute XP
        const dList = document.getElementById('daily-breakdown-list');
        dList.innerHTML = '';
        const dData = daily.daily_breakdown || {};
        const maxD = Math.max(...Object.values(dData), 1);
        Object.entries(dData).sort(([,a],[,b]) => b-a).forEach(([n, x]) => {
            if(x > 0) dList.innerHTML += createBar(n, x, (x/maxD)*100, '#10b981');
        });

        // 4. Spalte: Heute Fertig
        const cList = document.getElementById('completed-today-list');
        cList.innerHTML = '';
        const done = daily.completed_today || [];
        if(done.length === 0) cList.innerHTML = "<p class='text-gray-500'>Keine Quests heute.</p>";
        done.forEach(t => {
            cList.innerHTML += `<div class="text-sm p-2 bg-gray-800/50 rounded border-l-4 border-green-500 mb-1">✅ ${t}</div>`;
        });
    }

    document.addEventListener('DOMContentLoaded', renderDashboard);
</script>
</body>
</html>
