<!DOCTYPE html>
<html lang="de">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life-RPG Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { --rpg-bg: #1f2937; --rpg-primary: #10b981; --rpg-secondary: #fcd34d; }
        body { font-family: 'Inter', sans-serif; background-color: var(--rpg-bg); color: #f3f4f6; padding: 20px; margin: 0; }
        .stat-card { background-color: #374151; border: 2px solid var(--rpg-primary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        .progress-bar-container { height: 12px; background-color: #4b5563; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; transition: width 0.5s ease-in-out; }
        .scroll-area { height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--rpg-primary) transparent; }
    </style>
</head>
<body>

<div class="max-w-7xl mx-auto space-y-8">
    
    <header class="text-center pb-4 border-b border-gray-600">
        <h1 class="text-4xl font-extrabold text-rpg-primary">LIFE-RPG DASHBOARD V5</h1>
        <p class="text-lg text-gray-300 mt-1" id="latest-sync-date">Lade...</p>
    </header>

    <section>
        <div id="player-status-card" class="stat-card p-6 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <p class="text-sm font-semibold text-gray-400">Level</p>
                <p id="current-level" class="text-5xl font-extrabold text-white">?</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-gray-400">Gesamt-XP</p>
                <p id="total-xp" class="text-3xl font-bold text-white">0.0</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-gray-400">Fortschritt</p>
                <div class="progress-bar-container">
                    <div id="xp-progress-bar" class="progress-bar" style="width: 0%; background-color: var(--rpg-secondary);"></div>
                </div>
                <p class="text-sm text-gray-300 mt-1"><span id="xp-since-level">0</span> / 100 XP</p>
            </div>
        </div>
    </section>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">XP Heute</p>
            <p id="xp-gained-today" class="text-3xl font-bold text-rpg-primary">0.0</p>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">Aufgaben erledigt</p>
            <p id="tasks-completed-total" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <h3 class="text-xs font-semibold text-rpg-secondary uppercase">Highlights</h3>
            <div class="text-sm mt-1">
                <p class="flex justify-between"><span>KM:</span> <span id="total-run-km-display" class="text-rpg-primary font-mono">0.0</span></p>
                <p class="flex justify-between"><span>Zeit:</span> <span id="total-run-minutes-display" class="text-rpg-primary font-mono">0h</span></p>
                <p class="flex justify-between"><span>Sally (Best):</span> <span id="latest-sallyup-display" class="text-rpg-primary font-mono">N/A</span></p>
            </div>
        </div>
        <div class="stat-card p-4 rounded-lg">
            <p class="text-sm font-semibold text-gray-400">Aktivzeit Heute</p>
            <p id="minutes-spent-total" class="text-3xl font-bold text-white">0 min</p>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-8 space-y-8">
        <section class="stat-card p-5 rounded-lg">
            <h2 class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Skill-Fortschritt (Gesamt)</h2>
            <div id="skill-progress-list" class="space-y-4 scroll-area pr-2"></div>
        </section>

        <section class="stat-card p-5 rounded-lg border-emerald-500">
            <h2 class="text-xl font-bold text-rpg-primary mb-4 border-b border-gray-600 pb-2">Aktiver Tag</h2>
            <div id="daily-breakdown-list" class="space-y-4"></div>
        </section>
    </div>

    <div class="lg:col-span-4 space-y-8">
        <section class="stat-card p-5 rounded-lg">
            <h2 class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Offene Quests</h2>
            <div id="open-tasks-list" class="space-y-2 scroll-area pr-2"></div>
        </section>

        <section class="stat-card p-5 rounded-lg">
            <h2 class="text-xl font-bold text-rpg-secondary mb-4 border-b border-gray-600 pb-2">Ziel-Fortschritt</h2>
            <div id="goal-progress-list" class="space-y-4"></div>
        </section>

        <section class="stat-card p-5 rounded-lg border-emerald-500">
            <h2 class="text-xl font-bold text-rpg-primary mb-4 border-b border-gray-600 pb-2">Heute abgeschlossen</h2>
            <div id="completed-today-list" class="space-y-2 scroll-area pr-2"></div>
        </section>
    </div>
</div>
</div>

<script>
// <START_JSON_INJECTION>
    const MOCK_DATA = {
    "total_xp": 1096.44,
    "skill_xp_gained": {
        "Intellektuell": 397.0,
        "Physisch": 76.78,
        "Finanziell": 176.0,
        "Sozial": 234.67,
        "Sprachlich": 7.5,
        "Spirituell": 73.5,
        "Allgemein": 131.0
    },
    "run_metrics": {
        "total_km": 19.2,
        "total_minutes": 92.8
    },
    "sallyup_best_time": 2.5,
    "last_processed_date": null,
    "open_tasks": {
        "Intellektuell": [],
        "Physisch": [],
        "Finanziell": [],
        "Sozial": [],
        "Sprachlich": [],
        "Spirituell": [],
        "Allgemein": [
            "Bürgerbüro (führungszeugnis und einwohnermeldeamt)",
            "Quanten Blatt 14 mündlich",
            "Astrophysik Vorlesungen (nach 29.01)",
            "Kapitel in PKM oder Kapitel in Quanten",
            "Übungsblatt Quanten",
            "Übungsblatt PKM"
        ]
    },
    "latest_daily_stats": {
        "total_xp_today": 14.680555555555555,
        "tasks_today": 6,
        "minutes_today": 262.0833333333333,
        "daily_breakdown": {
            "Intellektuell": 8.0,
            "Physisch": 3.6805555555555554,
            "Finanziell": 0.0,
            "Sozial": 0.0,
            "Sprachlich": 0.0,
            "Spirituell": 0.0,
            "Allgemein": 3.0
        },
        "completed_today": [
            "Quanten Aufgabe schriftlich (1h 30m) #study ",
            "Wäsche (1p) #task ",
            "Wäsche abgenommen (1p) #task ",
            "Omelette gekocht (1p) #cooking ",
            "Quanten Aufgabe mündlich (2h 30m) #study",
            "Um die Promenade gelaufen (4.7km) (22:05min) #run"
        ]
    },
    "goal_progress": {}
};
// <END_JSON_INJECTION>

    function createBar(name, xp, percent, color) {
        return `<div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-bold text-gray-300 uppercase">${name}</span>
                <span class="text-rpg-secondary font-mono">${xp.toFixed(1)} XP</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percent}%; background-color: ${color};"></div>
            </div>
        </div>`;
    }

    function createGoalBar(name, completed, total) {
        const percent = total ? Math.min((completed / total) * 100, 100) : 0;
        const progressText = total ? `${completed} / ${total}` : `${completed} erledigt`;
        const barColor = total ? 'var(--rpg-secondary)' : 'var(--rpg-primary)';
        return `<div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-bold text-gray-300">${name}</span>
                <span class="text-gray-200 font-mono">${progressText}</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${percent}%; background-color: ${barColor};"></div>
            </div>
        </div>`;
    }

    async function loadDashboardData() {
        if (window.location.protocol.startsWith('http')) {
            try {
                const response = await fetch('08_System/life_rpg_data_v5.json', { cache: 'no-store' });
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('Konnte JSON nicht laden, nutze MOCK_DATA.', error);
            }
        }
        return MOCK_DATA;
    }

    async function renderDashboard() {
        const stats = await loadDashboardData();
        
        // Header & Status
        document.getElementById('latest-sync-date').textContent = `Synchro: ${stats.last_processed_date || 'N/A'}`;
        const txp = stats.total_xp || 0;
        document.getElementById('total-xp').textContent = txp.toFixed(2);
        document.getElementById('current-level').textContent = Math.floor(txp / 100) + 1;
        document.getElementById('xp-since-level').textContent = (txp % 100).toFixed(1);
        document.getElementById('xp-progress-bar').style.width = `${txp % 100}%`;

        // Metriken
        const daily = stats.latest_daily_stats || {};
        document.getElementById('xp-gained-today').textContent = (daily.total_xp_today || 0).toFixed(2);
        document.getElementById('tasks-completed-total').textContent = daily.tasks_today || 0;
        document.getElementById('minutes-spent-total').textContent = `${Math.round(daily.minutes_today || 0)} min`;
        
        const rkm = stats.run_metrics?.total_km || 0;
        const rmin = stats.run_metrics?.total_minutes || 0;
        document.getElementById('total-run-km-display').textContent = rkm.toFixed(1) + " km";
        document.getElementById('total-run-minutes-display').textContent = Math.floor(rmin/60) + "h " + Math.round(rmin%60) + "m";
        // --- Sally Up Bestzeit Anzeige ---
        const sallyMinRaw = stats.sallyup_best_time || 0;
        const sallyDisplay = document.getElementById('latest-sallyup-display');
        if (sallyDisplay) {
            if (sallyMinRaw > 0) {
                const sMin = Math.floor(sallyMinRaw);
                const sSec = Math.round((sallyMinRaw - sMin) * 60);
                sallyDisplay.textContent = `${sMin}:${sSec.toString().padStart(2, '0')} min`;
            } else {
                sallyDisplay.textContent = "0:00 min";
            }
        }

        // 1. Spalte: Gesamt Skills
        const sList = document.getElementById('skill-progress-list');
        const sData = stats.skill_xp_gained || {};
        const maxS = Math.max(...Object.values(sData), 1);
        Object.entries(sData).sort(([,a],[,b]) => b-a).forEach(([n, x]) => {
            if(x > 0) sList.innerHTML += createBar(n, x, (x/maxS)*100, 'var(--rpg-primary)');
        });

        // 2. Spalte: Offene Quests
        const oList = document.getElementById('open-tasks-list');
        Object.entries(stats.open_tasks || {}).forEach(([cat, tasks]) => {
            tasks.forEach(t => {
                oList.innerHTML += `<div class="text-sm p-2 bg-gray-800/50 rounded border-l-4 border-yellow-500 mb-1">${t}</div>`;
            });
        });

        // 3. Spalte: Heute XP
        const dList = document.getElementById('daily-breakdown-list');
        const dData = daily.daily_breakdown || {};
        const maxD = Math.max(...Object.values(dData), 1);
        Object.entries(dData).sort(([,a],[,b]) => b-a).forEach(([n, x]) => {
            if(x > 0) dList.innerHTML += createBar(n, x, (x/maxD)*100, '#10b981');
        });

        const gList = document.getElementById('goal-progress-list');
        const gData = stats.goal_progress || {};
        const goalEntries = Object.entries(gData);
        if (goalEntries.length === 0) {
            gList.innerHTML = "<p class='text-gray-500 text-sm'>Keine Ziele gefunden.</p>";
        } else {
            goalEntries.sort(([,a],[,b]) => (b.completed || 0) - (a.completed || 0))
                .forEach(([name, data]) => {
                    gList.innerHTML += createGoalBar(name, data.completed || 0, data.total || null);
                });
        }

        // 4. Spalte: Heute Fertig
        const cList = document.getElementById('completed-today-list');
        const done = daily.completed_today || [];
        if(done.length === 0) cList.innerHTML = "<p class='text-gray-500'>Keine Quests heute.</p>";
        done.forEach(t => {
            cList.innerHTML += `<div class="text-sm p-2 bg-gray-800/50 rounded border-l-4 border-green-500 mb-1">✅ ${t}</div>`;
        });
    }

    document.addEventListener('DOMContentLoaded', renderDashboard);
</script>
</body>
</html>
